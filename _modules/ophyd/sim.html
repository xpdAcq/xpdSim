
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" />
    <title>ophyd.sim &#8212; xpdSim  documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for ophyd.sim</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">time</span> <span class="k">as</span> <span class="nn">ttime</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span><span class="p">,</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">mkdtemp</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">weakref</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="kn">from</span> <span class="nn">.signal</span> <span class="kn">import</span> <span class="n">Signal</span><span class="p">,</span> <span class="n">EpicsSignal</span><span class="p">,</span> <span class="n">EpicsSignalRO</span>
<span class="kn">from</span> <span class="nn">.areadetector.base</span> <span class="kn">import</span> <span class="n">EpicsSignalWithRBV</span>
<span class="kn">from</span> <span class="nn">.status</span> <span class="kn">import</span> <span class="n">DeviceStatus</span><span class="p">,</span> <span class="n">StatusBase</span>
<span class="kn">from</span> <span class="nn">.device</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Device</span><span class="p">,</span> <span class="n">Component</span><span class="p">,</span> <span class="n">Component</span> <span class="k">as</span> <span class="n">C</span><span class="p">,</span>
                     <span class="n">DynamicDeviceComponent</span> <span class="k">as</span> <span class="n">DDC</span><span class="p">,</span> <span class="n">Kind</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">SimpleNamespace</span>
<span class="kn">from</span> <span class="nn">.pseudopos</span> <span class="kn">import</span> <span class="p">(</span><span class="n">PseudoPositioner</span><span class="p">,</span> <span class="n">PseudoSingle</span><span class="p">,</span>
                        <span class="n">real_position_argument</span><span class="p">,</span> <span class="n">pseudo_position_argument</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.positioner</span> <span class="kn">import</span> <span class="n">SoftPositioner</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">DO_NOT_USE</span><span class="p">,</span> <span class="n">ReadOnlyError</span><span class="p">,</span> <span class="n">LimitError</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># two convenience functions &#39;vendored&#39; from bluesky.utils</span>

<span class="k">def</span> <span class="nf">new_uid</span><span class="p">():</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">short_uid</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">truncate</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
    <span class="s2">&quot;Return a readable but unique id like &#39;label-fjfi5a&#39;&quot;</span>
    <span class="k">if</span> <span class="n">label</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">label</span><span class="p">,</span> <span class="n">new_uid</span><span class="p">()[:</span><span class="n">truncate</span><span class="p">]])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">new_uid</span><span class="p">()[:</span><span class="n">truncate</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">NullStatus</span><span class="p">(</span><span class="n">StatusBase</span><span class="p">):</span>
    <span class="s2">&quot;A simple Status object that is always immediately done, successfully.&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finished</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SynSignal</span><span class="p">(</span><span class="n">Signal</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A synthetic Signal that evaluates a Python function when triggered.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    func : callable, optional</span>
<span class="sd">        This function sets the signal to a new value when it is triggered.</span>
<span class="sd">        Expected signature: ``f() -&gt; value``.</span>
<span class="sd">        By default, triggering the signal does not change the value.</span>
<span class="sd">    name : string, keyword only</span>
<span class="sd">    exposure_time : number, optional</span>
<span class="sd">        Seconds of delay when triggered (simulated &#39;exposure time&#39;). Default is</span>
<span class="sd">        0.</span>
<span class="sd">    precision : integer, optional</span>
<span class="sd">        Digits of precision. Default is 3.</span>
<span class="sd">    parent : Device, optional</span>
<span class="sd">        Used internally if this Signal is made part of a larger Device.</span>
<span class="sd">    kind : a member the Kind IntEnum (or equivalent integer), optional</span>
<span class="sd">        Default is Kind.normal. See Kind for options.</span>
<span class="sd">    loop : asyncio.EventLoop, optional</span>
<span class="sd">        used for ``subscribe`` updates; uses ``asyncio.get_event_loop()`` if</span>
<span class="sd">        unspecified</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># This signature is arranged to mimic the signature of EpicsSignal, where</span>
    <span class="c1"># the Python function (func) takes the place of the PV.</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
                 <span class="n">name</span><span class="p">,</span>  <span class="c1"># required, keyword-only</span>
                 <span class="n">exposure_time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                 <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">kind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">loop</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># When triggered, just put the current value.</span>
            <span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span>
            <span class="c1"># Initialize readback with a None value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_readback</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">loop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_func</span> <span class="o">=</span> <span class="n">func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exposure_time</span> <span class="o">=</span> <span class="n">exposure_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">precision</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span> <span class="o">=</span> <span class="n">loop</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_func</span><span class="p">(),</span> <span class="n">timestamp</span><span class="o">=</span><span class="n">ttime</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                         <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">describe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
        <span class="c1"># There should be only one key here, but for the sake of generality....</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
            <span class="n">res</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;precision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">precision</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">delay_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exposure_time</span>
        <span class="k">if</span> <span class="n">delay_time</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">DeviceStatus</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>

                <span class="k">def</span> <span class="nf">update_and_finish</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_func</span><span class="p">())</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">_finished</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">call_later</span><span class="p">(</span><span class="n">delay_time</span><span class="p">,</span> <span class="n">update_and_finish</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="k">def</span> <span class="nf">sleep_and_finish</span><span class="p">():</span>
                    <span class="n">ttime</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay_time</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_func</span><span class="p">())</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">_finished</span><span class="p">()</span>

                <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">sleep_and_finish</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">st</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_func</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">NullStatus</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Get a new value, which allows us to synthesize noisy data, for</span>
        <span class="c1"># example.</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">SignalRO</span><span class="p">(</span><span class="n">Signal</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ReadOnlyError</span><span class="p">(</span><span class="s2">&quot;The signal </span><span class="si">{}</span><span class="s2"> is readonly.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ReadOnlyError</span><span class="p">(</span><span class="s2">&quot;The signal </span><span class="si">{}</span><span class="s2"> is readonly.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">SynSignalRO</span><span class="p">(</span><span class="n">SignalRO</span><span class="p">,</span> <span class="n">SynSignal</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">periodic_update</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">period_jitter</span><span class="p">):</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="n">ref</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">signal</span><span class="p">:</span>
            <span class="c1"># Our target Signal has been garbage collected. Shut down the</span>
            <span class="c1"># Thread.</span>
            <span class="k">return</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">_func</span><span class="p">())</span>
        <span class="k">del</span> <span class="n">signal</span>
        <span class="c1"># Sleep for period +/- period_jitter.</span>
        <span class="n">ttime</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">period</span> <span class="o">+</span> <span class="n">period_jitter</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(),</span> <span class="mi">0</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">SynPeriodicSignal</span><span class="p">(</span><span class="n">SynSignal</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A synthetic Signal that evaluates a Python function periodically.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    func : callable, optional</span>
<span class="sd">        This function sets the signal to a new value when it is triggered.</span>
<span class="sd">        Expected signature: ``f() -&gt; value``.</span>
<span class="sd">        By default, triggering the signal generates white noise on [0, 1].</span>
<span class="sd">    name : string, keyword only</span>
<span class="sd">    period : number, optional</span>
<span class="sd">        How often the Signal&#39;s value is updated in the background. Default is</span>
<span class="sd">        1 second.</span>
<span class="sd">    period_jitter : number, optional</span>
<span class="sd">        Random Gaussian variation of the period. Default is 1 second.</span>
<span class="sd">    exposure_time : number, optional</span>
<span class="sd">        Seconds of delay when triggered (simulated &#39;exposure time&#39;). Default is</span>
<span class="sd">        0.</span>
<span class="sd">    parent : Device, optional</span>
<span class="sd">        Used internally if this Signal is made part of a larger Device.</span>
<span class="sd">    kind : a member the Kind IntEnum (or equivalent integer), optional</span>
<span class="sd">        Default is Kind.normal. See Kind for options.</span>
<span class="sd">    loop : asyncio.EventLoop, optional</span>
<span class="sd">        used for ``subscribe`` updates; uses ``asyncio.get_event_loop()`` if</span>
<span class="sd">        unspecified</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
                 <span class="n">name</span><span class="p">,</span>  <span class="c1"># required, keyword-only</span>
                 <span class="n">period</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">period_jitter</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">exposure_time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">kind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">loop</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="p">,</span>
                         <span class="n">exposure_time</span><span class="o">=</span><span class="n">exposure_time</span><span class="p">,</span>
                         <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="n">loop</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">periodic_update</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                         <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
                                               <span class="n">period</span><span class="p">,</span>
                                               <span class="n">period_jitter</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">ReadbackSignal</span><span class="p">(</span><span class="n">SignalRO</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sim_state</span><span class="p">[</span><span class="s1">&#39;readback&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">describe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
        <span class="c1"># There should be only one key here, but for the sake of generality....</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
            <span class="n">res</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;precision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">precision</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Timestamp of the readback value&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sim_state</span><span class="p">[</span><span class="s1">&#39;readback_ts&#39;</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">SetpointSignal</span><span class="p">(</span><span class="n">Signal</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sim_state</span><span class="p">[</span><span class="s1">&#39;setpoint&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">describe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
        <span class="c1"># There should be only one key here, but for the sake of generality....</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
            <span class="n">res</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;precision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">precision</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Timestamp of the readback value&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sim_state</span><span class="p">[</span><span class="s1">&#39;setpoint_ts&#39;</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">SynAxisNoHints</span><span class="p">(</span><span class="n">Device</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A synthetic settable Device mimic any 1D Axis (position, temperature).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : string, keyword only</span>
<span class="sd">    readback_func : callable, optional</span>
<span class="sd">        When the Device is set to ``x``, its readback will be updated to</span>
<span class="sd">        ``f(x)``. This can be used to introduce random noise or a systematic</span>
<span class="sd">        offset.</span>
<span class="sd">        Expected signature: ``f(x) -&gt; value``.</span>
<span class="sd">    value : object, optional</span>
<span class="sd">        The initial value. Default is 0.</span>
<span class="sd">    delay : number, optional</span>
<span class="sd">        Simulates how long it takes the device to &quot;move&quot;. Default is 0 seconds.</span>
<span class="sd">    precision : integer, optional</span>
<span class="sd">        Digits of precision. Default is 3.</span>
<span class="sd">    parent : Device, optional</span>
<span class="sd">        Used internally if this Signal is made part of a larger Device.</span>
<span class="sd">    kind : a member the Kind IntEnum (or equivalent integer), optional</span>
<span class="sd">        Default is Kind.normal. See Kind for options.</span>
<span class="sd">    loop : asyncio.EventLoop, optional</span>
<span class="sd">        used for ``subscribe`` updates; uses ``asyncio.get_event_loop()`` if</span>
<span class="sd">        unspecified</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">readback</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">ReadbackSignal</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;hinted&#39;</span><span class="p">)</span>
    <span class="n">setpoint</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">SetpointSignal</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;normal&#39;</span><span class="p">)</span>

    <span class="n">velocity</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">Signal</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;config&#39;</span><span class="p">)</span>
    <span class="n">acceleration</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">Signal</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;config&#39;</span><span class="p">)</span>

    <span class="n">unused</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">Signal</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;omitted&#39;</span><span class="p">)</span>

    <span class="n">SUB_READBACK</span> <span class="o">=</span> <span class="s1">&#39;readback&#39;</span>
    <span class="n">_default_sub</span> <span class="o">=</span> <span class="n">SUB_READBACK</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span>
                 <span class="n">name</span><span class="p">,</span>
                 <span class="n">readback_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">precision</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                 <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">kind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">loop</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">readback_func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">readback_func</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">x</span>
        <span class="k">if</span> <span class="n">loop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim_state</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_readback_func</span> <span class="o">=</span> <span class="n">readback_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">delay</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">precision</span> <span class="o">=</span> <span class="n">precision</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span> <span class="o">=</span> <span class="n">loop</span>

        <span class="c1"># initialize values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim_state</span><span class="p">[</span><span class="s1">&#39;setpoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim_state</span><span class="p">[</span><span class="s1">&#39;setpoint_ts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ttime</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim_state</span><span class="p">[</span><span class="s1">&#39;readback&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">readback_func</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim_state</span><span class="p">[</span><span class="s1">&#39;readback_ts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ttime</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readback</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">old_setpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_state</span><span class="p">[</span><span class="s1">&#39;setpoint&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim_state</span><span class="p">[</span><span class="s1">&#39;setpoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim_state</span><span class="p">[</span><span class="s1">&#39;setpoint_ts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ttime</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setpoint</span><span class="o">.</span><span class="n">_run_subs</span><span class="p">(</span><span class="n">sub_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">setpoint</span><span class="o">.</span><span class="n">SUB_VALUE</span><span class="p">,</span>
                                <span class="n">old_value</span><span class="o">=</span><span class="n">old_setpoint</span><span class="p">,</span>
                                <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_state</span><span class="p">[</span><span class="s1">&#39;setpoint&#39;</span><span class="p">],</span>
                                <span class="n">timestamp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_state</span><span class="p">[</span><span class="s1">&#39;setpoint_ts&#39;</span><span class="p">])</span>

        <span class="k">def</span> <span class="nf">update_state</span><span class="p">():</span>
            <span class="n">old_readback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_state</span><span class="p">[</span><span class="s1">&#39;readback&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim_state</span><span class="p">[</span><span class="s1">&#39;readback&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readback_func</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim_state</span><span class="p">[</span><span class="s1">&#39;readback_ts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ttime</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">readback</span><span class="o">.</span><span class="n">_run_subs</span><span class="p">(</span><span class="n">sub_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">readback</span><span class="o">.</span><span class="n">SUB_VALUE</span><span class="p">,</span>
                                    <span class="n">old_value</span><span class="o">=</span><span class="n">old_readback</span><span class="p">,</span>
                                    <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_state</span><span class="p">[</span><span class="s1">&#39;readback&#39;</span><span class="p">],</span>
                                    <span class="n">timestamp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_state</span><span class="p">[</span><span class="s1">&#39;readback_ts&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_subs</span><span class="p">(</span><span class="n">sub_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">SUB_READBACK</span><span class="p">,</span>
                           <span class="n">old_value</span><span class="o">=</span><span class="n">old_readback</span><span class="p">,</span>
                           <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_state</span><span class="p">[</span><span class="s1">&#39;readback&#39;</span><span class="p">],</span>
                           <span class="n">timestamp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_state</span><span class="p">[</span><span class="s1">&#39;readback_ts&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delay</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">DeviceStatus</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>

                <span class="k">def</span> <span class="nf">update_and_finish</span><span class="p">():</span>
                    <span class="n">update_state</span><span class="p">()</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">_finished</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">call_later</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delay</span><span class="p">,</span> <span class="n">update_and_finish</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="k">def</span> <span class="nf">sleep_and_finish</span><span class="p">():</span>
                    <span class="n">ttime</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delay</span><span class="p">)</span>
                    <span class="n">update_state</span><span class="p">()</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">_finished</span><span class="p">()</span>

                <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">sleep_and_finish</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">st</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">update_state</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">NullStatus</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">readback</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">SynAxis</span><span class="p">(</span><span class="n">SynAxisNoHints</span><span class="p">):</span>
    <span class="n">readback</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">ReadbackSignal</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">Kind</span><span class="o">.</span><span class="n">hinted</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SynGauss</span><span class="p">(</span><span class="n">SynSignal</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate a point on a Gaussian based on the value of a motor.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : string</span>
<span class="sd">    motor : Device</span>
<span class="sd">    motor_field : string</span>
<span class="sd">    center : number</span>
<span class="sd">        center of peak</span>
<span class="sd">    Imax : number</span>
<span class="sd">        max intensity of peak</span>
<span class="sd">    sigma : number, optional</span>
<span class="sd">        Default is 1.</span>
<span class="sd">    noise : {&#39;poisson&#39;, &#39;uniform&#39;, None}, optional</span>
<span class="sd">        Add noise to the gaussian peak.</span>
<span class="sd">    noise_multiplier : float, optional</span>
<span class="sd">        Only relevant for &#39;uniform&#39; noise. Multiply the random amount of</span>
<span class="sd">        noise by &#39;noise_multiplier&#39;</span>
<span class="sd">    random_state : numpy random state object, optional</span>
<span class="sd">        np.random.RandomState(0), to generate random number with given seed</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    motor = SynAxis(name=&#39;motor&#39;)</span>
<span class="sd">    det = SynGauss(&#39;det&#39;, motor, &#39;motor&#39;, center=0, Imax=1, sigma=1)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">motor</span><span class="p">,</span> <span class="n">motor_field</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">Imax</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">noise</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">noise_multiplier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">noise</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;poisson&#39;</span><span class="p">,</span> <span class="s1">&#39;uniform&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;noise must be one of &#39;poisson&#39;, &#39;uniform&#39;, None&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_motor</span> <span class="o">=</span> <span class="n">motor</span>
        <span class="k">if</span> <span class="n">random_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">random_state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span>

        <span class="k">def</span> <span class="nf">func</span><span class="p">():</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">motor</span><span class="o">.</span><span class="n">read</span><span class="p">()[</span><span class="n">motor_field</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">Imax</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">noise</span> <span class="o">==</span> <span class="s1">&#39;poisson&#39;</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">random_state</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">noise</span> <span class="o">==</span> <span class="s1">&#39;uniform&#39;</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">+=</span> <span class="n">random_state</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">noise_multiplier</span>
            <span class="k">return</span> <span class="n">v</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Syn2DGauss</span><span class="p">(</span><span class="n">SynSignal</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate a point on a Gaussian based on the value of a motor.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        The name of the detector</span>
<span class="sd">    motor0 : SynAxis</span>
<span class="sd">        The &#39;x&#39; coordinate of the 2-D gaussian blob</span>
<span class="sd">    motor_field0 : str</span>
<span class="sd">        The name field of the motor. Should be the key in motor0.describe()</span>
<span class="sd">    motor1 : SynAxis</span>
<span class="sd">        The &#39;y&#39; coordinate of the 2-D gaussian blob</span>
<span class="sd">    motor_field1 : str</span>
<span class="sd">        The name field of the motor. Should be the key in motor1.describe()</span>
<span class="sd">    center : iterable, optional</span>
<span class="sd">        The center of the gaussian blob</span>
<span class="sd">        Defaults to (0,0)</span>
<span class="sd">    Imax : float, optional</span>
<span class="sd">        The intensity at `center`</span>
<span class="sd">        Defaults to 1</span>
<span class="sd">    sigma : float, optional</span>
<span class="sd">        Standard deviation for gaussian blob</span>
<span class="sd">        Defaults to 1</span>
<span class="sd">    noise : {&#39;poisson&#39;, &#39;uniform&#39;, None}, optional</span>
<span class="sd">        Add noise to the gaussian peak..</span>
<span class="sd">        Defaults to None</span>
<span class="sd">    noise_multiplier : float, optional</span>
<span class="sd">        Only relevant for &#39;uniform&#39; noise. Multiply the random amount of</span>
<span class="sd">        noise by &#39;noise_multiplier&#39;</span>
<span class="sd">        Defaults to 1</span>
<span class="sd">    random_state : numpy random state object, optional</span>
<span class="sd">        np.random.RandomState(0), to generate random number with given seed</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    motor = SynAxis(name=&#39;motor&#39;)</span>
<span class="sd">    det = SynGauss(&#39;det&#39;, motor, &#39;motor&#39;, center=0, Imax=1, sigma=1)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">motor0</span><span class="p">,</span> <span class="n">motor_field0</span><span class="p">,</span> <span class="n">motor1</span><span class="p">,</span> <span class="n">motor_field1</span><span class="p">,</span>
                 <span class="n">center</span><span class="p">,</span> <span class="n">Imax</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">noise_multiplier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">random_state</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">noise</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;poisson&#39;</span><span class="p">,</span> <span class="s1">&#39;uniform&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;noise must be one of &#39;poisson&#39;, &#39;uniform&#39;, None&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_motor</span> <span class="o">=</span> <span class="n">motor0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_motor1</span> <span class="o">=</span> <span class="n">motor1</span>
        <span class="k">if</span> <span class="n">random_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">random_state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span>

        <span class="k">def</span> <span class="nf">func</span><span class="p">():</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">motor0</span><span class="o">.</span><span class="n">read</span><span class="p">()[</span><span class="n">motor_field0</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">motor1</span><span class="o">.</span><span class="n">read</span><span class="p">()[</span><span class="n">motor_field1</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">Imax</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">m</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">noise</span> <span class="o">==</span> <span class="s1">&#39;poisson&#39;</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">random_state</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">noise</span> <span class="o">==</span> <span class="s1">&#39;uniform&#39;</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">+=</span> <span class="n">random_state</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">noise_multiplier</span>
            <span class="k">return</span> <span class="n">v</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TrivialFlyer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Trivial flyer that complies to the API but returns empty data.&quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;trivial_flyer&#39;</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">kickoff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">NullStatus</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">describe_collect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;stream_name&#39;</span><span class="p">:</span> <span class="p">{}}</span>

    <span class="k">def</span> <span class="nf">read_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">OrderedDict</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">describe_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">OrderedDict</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">complete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">NullStatus</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
            <span class="k">yield</span> <span class="p">{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;timestamps&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;seq_num&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">pass</span>

<span class="k">class</span> <span class="nc">NewTrivialFlyer</span><span class="p">(</span><span class="n">TrivialFlyer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The old-style API inserted Resource and Datum documents into a database directly. </span>
<span class="sd">    The new-style API only caches the documents and provides an interface (collect_asset_docs) </span>
<span class="sd">    for accessing that cache. This change was part of the &quot;asset refactor&quot; that changed</span>
<span class="sd">    that way Resource and Datum documents flowed through ophyd, bluesky, and databroker.</span>
<span class="sd">    Trivial flyer that complies to the API but returns empty data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;new_trivial_flyer&#39;</span>

    <span class="k">def</span> <span class="nf">collect_asset_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="p">():</span>
            <span class="k">yield</span> <span class="n">_</span>

<span class="k">class</span> <span class="nc">MockFlyer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for mocking a flyscan API implemented with stepper motors.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">detector</span><span class="p">,</span> <span class="n">motor</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mot</span> <span class="o">=</span> <span class="n">motor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_detector</span> <span class="o">=</span> <span class="n">detector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_completion_status</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">loop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span> <span class="o">=</span> <span class="n">loop</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">detector</span><span class="p">,</span> <span class="n">motor</span><span class="p">,</span> <span class="n">steps</span> <span class="o">=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mot</span> <span class="o">=</span> <span class="n">motor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_detector</span> <span class="o">=</span> <span class="n">detector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_steps</span> <span class="o">=</span> <span class="n">steps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_completion_status</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detector</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_steps</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">OrderedDict</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">describe_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">OrderedDict</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">describe_collect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">dd</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mot</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>
        <span class="n">dd</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_detector</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;stream_name&#39;</span><span class="p">:</span> <span class="n">dd</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">complete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_completion_status</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No collection in progress&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_completion_status</span>

    <span class="k">def</span> <span class="nf">kickoff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_completion_status</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Already kicked off.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scan</span><span class="p">)</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">DeviceStatus</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_completion_status</span> <span class="o">=</span> <span class="n">st</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_future</span><span class="o">.</span><span class="n">add_done_callback</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">st</span><span class="o">.</span><span class="n">_finished</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">st</span>

    <span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_completion_status</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_completion_status</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No reading until done!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_completion_status</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>

    <span class="k">def</span> <span class="nf">_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;This will be run on a separate thread, started in self.kickoff()&quot;</span>
        <span class="n">ttime</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="o">.</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_steps</span><span class="p">:</span>
            <span class="n">stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mot</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">stat</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">ttime</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
            <span class="n">stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detector</span><span class="o">.</span><span class="n">trigger</span><span class="p">()</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">stat</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">ttime</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

            <span class="n">event</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">event</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ttime</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">event</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">event</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_mot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_detector</span><span class="p">]:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">event</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                    <span class="n">event</span><span class="p">[</span><span class="s1">&#39;timestamps&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">SynSignalWithRegistry</span><span class="p">(</span><span class="n">SynSignal</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A SynSignal integrated with databroker.assets</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    func : callable, optional</span>
<span class="sd">        This function sets the signal to a new value when it is triggered.</span>
<span class="sd">        Expected signature: ``f() -&gt; value``.</span>
<span class="sd">        By default, triggering the signal does not change the value.</span>
<span class="sd">    name : string, keyword only</span>
<span class="sd">    exposure_time : number, optional</span>
<span class="sd">        Seconds of delay when triggered (simulated &#39;exposure time&#39;). Default is</span>
<span class="sd">        0.</span>
<span class="sd">    parent : Device, optional</span>
<span class="sd">        Used internally if this Signal is made part of a larger Device.</span>
<span class="sd">    loop : asyncio.EventLoop, optional</span>
<span class="sd">        used for ``subscribe`` updates; uses ``asyncio.get_event_loop()`` if</span>
<span class="sd">        unspecified</span>
<span class="sd">    reg : Registry, optional</span>
<span class="sd">        DEPRECATED. If used, this is ignored and a warning is issued. In a</span>
<span class="sd">        future release, this parameter will be removed.</span>
<span class="sd">    save_path : str, optional</span>
<span class="sd">        Path to save files to, if None make a temp dir, defaults to None.</span>
<span class="sd">    save_func : function, optional</span>
<span class="sd">        The function to save the data, function signature must be:</span>
<span class="sd">        `func(file_path, array)`, defaults to np.save</span>
<span class="sd">    save_spec : str, optional</span>
<span class="sd">        The spec for the save function, defaults to &#39;RWFS_NPY&#39;</span>
<span class="sd">    save_ext : str, optional</span>
<span class="sd">        The extension to add to the file name, defaults to &#39;.npy&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">reg</span><span class="o">=</span><span class="n">DO_NOT_USE</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">save_func</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                 <span class="n">save_spec</span><span class="o">=</span><span class="s1">&#39;NPY_SEQ&#39;</span><span class="p">,</span> <span class="n">save_ext</span><span class="o">=</span><span class="s1">&#39;npy&#39;</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_func</span> <span class="o">=</span> <span class="n">save_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_ext</span> <span class="o">=</span> <span class="n">save_ext</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resource_uid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_datum_counter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_asset_docs_cache</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">save_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_path</span> <span class="o">=</span> <span class="n">mkdtemp</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_path</span> <span class="o">=</span> <span class="n">save_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_spec</span> <span class="o">=</span> <span class="n">save_spec</span>  <span class="c1"># spec name stored in resource doc</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_file_stem</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path_stem</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">reg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">DO_NOT_USE</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The parameter &#39;reg&#39; is deprecated. It will be &quot;</span>
                          <span class="s2">&quot;ignored. In a future release the parameter will be &quot;</span>
                          <span class="s2">&quot;removed and passing a value for &#39;reg&#39; will raise &quot;</span>
                          <span class="s2">&quot;an error.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">reg</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reg</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">stage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_stem</span> <span class="o">=</span> <span class="n">short_uid</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_datum_counter</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path_stem</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_stem</span><span class="p">)</span>

        <span class="c1"># This is temporarily more complicated than it will be in the future.</span>
        <span class="c1"># It needs to support old configurations that have a registry.</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;spec&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spec</span><span class="p">,</span>
                    <span class="s1">&#39;root&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="p">,</span>
                    <span class="s1">&#39;resource_path&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_stem</span><span class="p">,</span>
                    <span class="s1">&#39;resource_kwargs&#39;</span><span class="p">:</span> <span class="p">{},</span>
                    <span class="s1">&#39;path_semantics&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;posix&#39;</span><span class="p">:</span> <span class="s1">&#39;posix&#39;</span><span class="p">,</span> <span class="s1">&#39;nt&#39;</span><span class="p">:</span> <span class="s1">&#39;windows&#39;</span><span class="p">}[</span><span class="n">os</span><span class="o">.</span><span class="n">name</span><span class="p">]}</span>
        <span class="c1"># If a Registry is set, we need to allow it to generate the uid for us.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># register_resource has accidentally different parameter names...</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resource_uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg</span><span class="o">.</span><span class="n">register_resource</span><span class="p">(</span>
                <span class="n">rpath</span><span class="o">=</span><span class="n">resource</span><span class="p">[</span><span class="s1">&#39;resource_path&#39;</span><span class="p">],</span>
                <span class="n">rkwargs</span><span class="o">=</span><span class="n">resource</span><span class="p">[</span><span class="s1">&#39;resource_kwargs&#39;</span><span class="p">],</span>
                <span class="n">root</span><span class="o">=</span><span class="n">resource</span><span class="p">[</span><span class="s1">&#39;root&#39;</span><span class="p">],</span>
                <span class="n">spec</span><span class="o">=</span><span class="n">resource</span><span class="p">[</span><span class="s1">&#39;spec&#39;</span><span class="p">],</span>
                <span class="n">path_semantics</span><span class="o">=</span><span class="n">resource</span><span class="p">[</span><span class="s1">&#39;path_semantics&#39;</span><span class="p">])</span>
        <span class="c1"># If a Registry is not set, we need to generate the uid.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resource_uid</span> <span class="o">=</span> <span class="n">new_uid</span><span class="p">()</span>
        <span class="n">resource</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource_uid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_asset_docs_cache</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;resource&#39;</span><span class="p">,</span> <span class="n">resource</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">trigger</span><span class="p">()</span>
        <span class="c1"># save file stash file name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">reading</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="c1"># Save the actual reading[&#39;value&#39;] to disk. For a real detector,</span>
            <span class="c1"># this part would be done by the detector IOC, not by ophyd.</span>
            <span class="n">data_counter</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_datum_counter</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_func</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path_stem</span><span class="p">,</span> <span class="n">data_counter</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">save_ext</span><span class="p">),</span> <span class="n">reading</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
            <span class="c1"># This is temporarily more complicated than it will be in the</span>
            <span class="c1"># future.  It needs to support old configurations that have a</span>
            <span class="c1"># registry.</span>
            <span class="n">datum</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;resource&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resource_uid</span><span class="p">,</span>
                     <span class="s1">&#39;datum_kwargs&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">data_counter</span><span class="p">)}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># If a Registry is set, we need to allow it to generate the</span>
                <span class="c1"># datum_id for us.</span>
                <span class="n">datum_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reg</span><span class="o">.</span><span class="n">register_datum</span><span class="p">(</span>
                    <span class="n">datum_kwargs</span><span class="o">=</span><span class="n">datum</span><span class="p">[</span><span class="s1">&#39;datum_kwargs&#39;</span><span class="p">],</span>
                    <span class="n">resource_uid</span><span class="o">=</span><span class="n">datum</span><span class="p">[</span><span class="s1">&#39;resource&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If a Registry is not set, we need to generate the datum_id.</span>
                <span class="n">datum_id</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_resource_uid</span><span class="p">,</span>
                                          <span class="n">data_counter</span><span class="p">)</span>
            <span class="n">datum</span><span class="p">[</span><span class="s1">&#39;datum_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datum_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_asset_docs_cache</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;datum&#39;</span><span class="p">,</span> <span class="n">datum</span><span class="p">))</span>
            <span class="c1"># And now change the reading in place, replacing the value with</span>
            <span class="c1"># a reference to Registry.</span>
            <span class="n">reading</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datum_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">reading</span>

        <span class="k">return</span> <span class="n">NullStatus</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span>

    <span class="k">def</span> <span class="nf">describe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
            <span class="n">res</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;external&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;FILESTORE&quot;</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">collect_asset_docs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_asset_docs_cache</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_asset_docs_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">item</span>

    <span class="k">def</span> <span class="nf">unstage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resource_uid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_datum_counter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_asset_docs_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_stem</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path_stem</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">NumpySeqHandler</span><span class="p">:</span>
    <span class="n">specs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;NPY_SEQ&#39;</span><span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">index</span><span class="p">),</span>
                       <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_file_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datum_kwarg_gen</span><span class="p">):</span>
        <span class="s2">&quot;This method is optional. It is not needed for access, but for export.&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{name}</span><span class="s1">_</span><span class="si">{index}</span><span class="s1">.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">kwargs</span> <span class="ow">in</span> <span class="n">datum_kwarg_gen</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">ABDetector</span><span class="p">(</span><span class="n">Device</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">SynSignal</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">Kind</span><span class="o">.</span><span class="n">hinted</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">SynSignal</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">trigger</span><span class="p">()</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">trigger</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">DetWithCountTime</span><span class="p">(</span><span class="n">Device</span><span class="p">):</span>
    <span class="n">intensity</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">SynSignal</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">Kind</span><span class="o">.</span><span class="n">hinted</span><span class="p">)</span>
    <span class="n">count_time</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">Signal</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">DetWithConf</span><span class="p">(</span><span class="n">Device</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">SynSignal</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">Kind</span><span class="o">.</span><span class="n">hinted</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">SynSignal</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">Kind</span><span class="o">.</span><span class="n">hinted</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">SynSignal</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">Component</span><span class="p">(</span><span class="n">SynSignal</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">4</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configuration_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">trigger</span><span class="p">()</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">trigger</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">InvariantSignal</span><span class="p">(</span><span class="n">SynSignal</span><span class="p">):</span>
    <span class="c1"># Always returns the same reading, including timestamp.</span>
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
            <span class="n">res</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;INVARIANT REPR&gt;&quot;</span>


<span class="k">class</span> <span class="nc">SPseudo3x3</span><span class="p">(</span><span class="n">PseudoPositioner</span><span class="p">):</span>
    <span class="n">pseudo1</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="n">PseudoSingle</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">egu</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">Kind</span><span class="o">.</span><span class="n">hinted</span><span class="p">)</span>
    <span class="n">pseudo2</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="n">PseudoSingle</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">egu</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">Kind</span><span class="o">.</span><span class="n">hinted</span><span class="p">)</span>
    <span class="n">pseudo3</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="n">PseudoSingle</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">egu</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">Kind</span><span class="o">.</span><span class="n">hinted</span><span class="p">)</span>
    <span class="n">real1</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="n">SoftPositioner</span><span class="p">,</span> <span class="n">init_pos</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">real2</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="n">SoftPositioner</span><span class="p">,</span> <span class="n">init_pos</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">real3</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="n">SoftPositioner</span><span class="p">,</span> <span class="n">init_pos</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">sig</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="n">Signal</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="nd">@pseudo_position_argument</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pseudo_pos</span><span class="p">):</span>
        <span class="n">pseudo_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PseudoPosition</span><span class="p">(</span><span class="o">*</span><span class="n">pseudo_pos</span><span class="p">)</span>
        <span class="c1"># logger.debug(&#39;forward %s&#39;, pseudo_pos)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">RealPosition</span><span class="p">(</span><span class="n">real1</span><span class="o">=-</span><span class="n">pseudo_pos</span><span class="o">.</span><span class="n">pseudo1</span><span class="p">,</span>
                                 <span class="n">real2</span><span class="o">=-</span><span class="n">pseudo_pos</span><span class="o">.</span><span class="n">pseudo2</span><span class="p">,</span>
                                 <span class="n">real3</span><span class="o">=-</span><span class="n">pseudo_pos</span><span class="o">.</span><span class="n">pseudo3</span><span class="p">)</span>

    <span class="nd">@real_position_argument</span>
    <span class="k">def</span> <span class="nf">inverse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">real_pos</span><span class="p">):</span>
        <span class="n">real_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RealPosition</span><span class="p">(</span><span class="o">*</span><span class="n">real_pos</span><span class="p">)</span>
        <span class="c1"># logger.debug(&#39;inverse %s&#39;, real_pos)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">PseudoPosition</span><span class="p">(</span><span class="n">pseudo1</span><span class="o">=-</span><span class="n">real_pos</span><span class="o">.</span><span class="n">real1</span><span class="p">,</span>
                                   <span class="n">pseudo2</span><span class="o">=-</span><span class="n">real_pos</span><span class="o">.</span><span class="n">real2</span><span class="p">,</span>
                                   <span class="n">pseudo3</span><span class="o">=-</span><span class="n">real_pos</span><span class="o">.</span><span class="n">real3</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SPseudo1x3</span><span class="p">(</span><span class="n">PseudoPositioner</span><span class="p">):</span>
    <span class="n">pseudo1</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="n">PseudoSingle</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">kind</span><span class="o">=</span><span class="n">Kind</span><span class="o">.</span><span class="n">hinted</span><span class="p">)</span>
    <span class="n">real1</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="n">SoftPositioner</span><span class="p">,</span> <span class="n">init_pos</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">real2</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="n">SoftPositioner</span><span class="p">,</span> <span class="n">init_pos</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">real3</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="n">SoftPositioner</span><span class="p">,</span> <span class="n">init_pos</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="nd">@pseudo_position_argument</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pseudo_pos</span><span class="p">):</span>
        <span class="n">pseudo_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PseudoPosition</span><span class="p">(</span><span class="o">*</span><span class="n">pseudo_pos</span><span class="p">)</span>
        <span class="c1"># logger.debug(&#39;forward %s&#39;, pseudo_pos)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">RealPosition</span><span class="p">(</span><span class="n">real1</span><span class="o">=-</span><span class="n">pseudo_pos</span><span class="o">.</span><span class="n">pseudo1</span><span class="p">,</span>
                                 <span class="n">real2</span><span class="o">=-</span><span class="n">pseudo_pos</span><span class="o">.</span><span class="n">pseudo1</span><span class="p">,</span>
                                 <span class="n">real3</span><span class="o">=-</span><span class="n">pseudo_pos</span><span class="o">.</span><span class="n">pseudo1</span><span class="p">)</span>

    <span class="nd">@real_position_argument</span>
    <span class="k">def</span> <span class="nf">inverse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">real_pos</span><span class="p">):</span>
        <span class="n">real_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RealPosition</span><span class="p">(</span><span class="o">*</span><span class="n">real_pos</span><span class="p">)</span>
        <span class="c1"># logger.debug(&#39;inverse %s&#39;, real_pos)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">PseudoPosition</span><span class="p">(</span><span class="n">pseudo1</span><span class="o">=-</span><span class="n">real_pos</span><span class="o">.</span><span class="n">real1</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SynAxisNoPosition</span><span class="p">(</span><span class="n">SynAxis</span><span class="p">):</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span>


<span class="k">def</span> <span class="nf">make_fake_device</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inspect cls and construct a fake device that has the same structure.</span>

<span class="sd">    This works by replacing EpicsSignal with FakeEpicsSignal and EpicsSignalRO</span>
<span class="sd">    with FakeEpicsSignalRO. The fake class will be a subclass of the real</span>
<span class="sd">    class.</span>

<span class="sd">    This assumes that EPICS connections are done entirely in EpicsSignal and</span>
<span class="sd">    EpicsSignalRO subcomponents. If this is not true, this will fail silently</span>
<span class="sd">    on class construction and loudly when manipulating an object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cls : Device</span>
<span class="sd">        A real Device class to inspect and create a fake Device class from</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fake_device : Device</span>
<span class="sd">        The resulting fake Device class</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Cache to avoid repeating work.</span>
    <span class="c1"># EpicsSignal and EpicsSignalRO begin in the cache.</span>
    <span class="k">if</span> <span class="bp">cls</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fake_device_cache</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">Device</span><span class="p">):</span>
            <span class="c1"># Ignore non-devices and non-epics-signals</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Ignore cls=</span><span class="si">%s</span><span class="s1">, bases are </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">)</span>
            <span class="n">fake_device_cache</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span>
            <span class="k">return</span> <span class="bp">cls</span>
        <span class="n">fake_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># Update all the components recursively</span>
        <span class="k">for</span> <span class="n">cpt_name</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">component_names</span><span class="p">:</span>
            <span class="n">cpt</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">cpt_name</span><span class="p">)</span>
            <span class="n">fake_cpt</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">cpt</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cpt</span><span class="p">,</span> <span class="n">Component</span><span class="p">):</span>
                <span class="n">fake_cpt</span><span class="o">.</span><span class="n">cls</span> <span class="o">=</span> <span class="n">make_fake_device</span><span class="p">(</span><span class="n">cpt</span><span class="o">.</span><span class="n">cls</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;switch cpt_name=</span><span class="si">%s</span><span class="s1"> to cls=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                             <span class="n">cpt_name</span><span class="p">,</span> <span class="n">fake_cpt</span><span class="o">.</span><span class="n">cls</span><span class="p">)</span>
            <span class="c1"># DDCpt stores the classes in a different place</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cpt</span><span class="p">,</span> <span class="n">DDC</span><span class="p">):</span>
                <span class="n">fake_defn</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">ddcpt_name</span><span class="p">,</span> <span class="n">ddcpt_tuple</span> <span class="ow">in</span> <span class="n">cpt</span><span class="o">.</span><span class="n">defn</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">subcls</span> <span class="o">=</span> <span class="n">make_fake_device</span><span class="p">(</span><span class="n">ddcpt_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">fake_defn</span><span class="p">[</span><span class="n">ddcpt_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">subcls</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">ddcpt_tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="n">fake_cpt</span><span class="o">.</span><span class="n">defn</span> <span class="o">=</span> <span class="n">fake_defn</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">((</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> is not a component or a dynamic &quot;</span>
                                    <span class="s2">&quot;device component. I don&#39;t know how you &quot;</span>
                                    <span class="s2">&quot;found this error, should be impossible &quot;</span>
                                    <span class="s2">&quot;to reach it.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cpt</span><span class="p">)))</span>
            <span class="n">fake_dict</span><span class="p">[</span><span class="n">cpt_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">fake_cpt</span>
        <span class="n">fake_class</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="s1">&#39;Fake</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">),</span> <span class="p">(</span><span class="bp">cls</span><span class="p">,),</span> <span class="n">fake_dict</span><span class="p">)</span>
        <span class="n">fake_device_cache</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span> <span class="o">=</span> <span class="n">fake_class</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;fake_device_cache[</span><span class="si">%s</span><span class="s1">] = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">fake_class</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fake_device_cache</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">FakeEpicsSignal</span><span class="p">(</span><span class="n">SynSignal</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fake version of EpicsSignal that&#39;s really just a SynSignal.</span>

<span class="sd">    Wheras SynSignal is generally used to test plans, FakeEpicsSignal is</span>
<span class="sd">    generally used in conjunction with make_fake_device to test any logic</span>
<span class="sd">    inside of a Device subclass.</span>

<span class="sd">    Unlike in SynSignal, this class is generally instantiated inside of a</span>
<span class="sd">    subcomponent generated automatically by make_fake_device. This means we</span>
<span class="sd">    need extra hooks for modifying the signal&#39;s properties after the class</span>
<span class="sd">    instantiates.</span>

<span class="sd">    We can emulate EpicsSignal features here. We currently emulate the put</span>
<span class="sd">    limits and some enum handling.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">read_pv</span><span class="p">,</span> <span class="n">write_pv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">pv_kw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">put_complete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">auto_monitor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Mimic EpicsSignal signature</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">as_string</span> <span class="o">=</span> <span class="n">string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enum_strs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_limits</span> <span class="o">=</span> <span class="n">limits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_put_func</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_limits</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">sim_set_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the SynSignal function to set a new value on trigger.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_func</span> <span class="o">=</span> <span class="n">func</span>

    <span class="k">def</span> <span class="nf">sim_set_putter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">putter</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define arbirary behavior on signal put.</span>

<span class="sd">        This can be used to emulate basic IOC behavior.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_put_func</span> <span class="o">=</span> <span class="n">putter</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">as_string</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">connection_timeout</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Implement getting as enum strings</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">as_string</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">as_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_string</span>

        <span class="n">value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">as_string</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enum_strs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">enum_strs</span><span class="p">[</span><span class="n">value</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Implement putting as enum strings and put functions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enum_strs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">enum_strs</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enum_strs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">err</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> not in enum strs </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">enum_strs</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_put_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_put_func</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">sim_put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the read-only signal&#39;s value.</span>

<span class="sd">        Implement here instead of FakeEpicsSignalRO so you can call it with</span>
<span class="sd">        every fake signal.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Signal</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">enum_strs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simulated enum strings.</span>

<span class="sd">        Use sim_set_enum_strs during setup to set the enum strs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enum_strs</span>

    <span class="k">def</span> <span class="nf">sim_set_enum_strs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enums</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the enum_strs for a fake device</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        enums: list or tuple of str</span>
<span class="sd">            The enums will be accessed by array index, e.g. the first item in</span>
<span class="sd">            enums will be 0, the next will be 1, etc.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enum_strs</span> <span class="o">=</span> <span class="n">enums</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">limits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_limits</span>

    <span class="k">def</span> <span class="nf">sim_set_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limits</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the fake signal&#39;s limits.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_limits</span> <span class="o">=</span> <span class="n">limits</span>

    <span class="k">def</span> <span class="nf">check_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Implement some of the checks from EpicsSignal</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">check_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot write None to EPICS PVs&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_limits</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">LimitError</span><span class="p">(</span>
                <span class="s1">&#39;value=</span><span class="si">{value}</span><span class="s1"> not within limits </span><span class="si">{self.limits}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">FakeEpicsSignalRO</span><span class="p">(</span><span class="n">SynSignalRO</span><span class="p">,</span> <span class="n">FakeEpicsSignal</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read-only FakeEpicsSignal</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">FakeEpicsSignalWithRBV</span><span class="p">(</span><span class="n">FakeEpicsSignal</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    FakeEpicsSignal with PV and PV_RBV; used in the AreaDetector PV naming scheme</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;_RBV&#39;</span><span class="p">,</span> <span class="n">write_pv</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="n">fake_device_cache</span> <span class="o">=</span> <span class="p">{</span><span class="n">EpicsSignal</span><span class="p">:</span> <span class="n">FakeEpicsSignal</span><span class="p">,</span>
                     <span class="n">EpicsSignalRO</span><span class="p">:</span> <span class="n">FakeEpicsSignalRO</span><span class="p">,</span>
                     <span class="n">EpicsSignalWithRBV</span><span class="p">:</span> <span class="n">FakeEpicsSignalWithRBV</span><span class="p">,</span>
                     <span class="p">}</span>


<span class="k">def</span> <span class="nf">hw</span><span class="p">():</span>
    <span class="s2">&quot;Build a set of synthetic hardware (hence the abbreviated name, hw)&quot;</span>
    <span class="n">motor</span> <span class="o">=</span> <span class="n">SynAxis</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;motor&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;motors&#39;</span><span class="p">})</span>
    <span class="n">motor1</span> <span class="o">=</span> <span class="n">SynAxis</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;motor1&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;motors&#39;</span><span class="p">})</span>
    <span class="n">motor2</span> <span class="o">=</span> <span class="n">SynAxis</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;motor2&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;motors&#39;</span><span class="p">})</span>
    <span class="n">motor3</span> <span class="o">=</span> <span class="n">SynAxis</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;motor3&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;motors&#39;</span><span class="p">})</span>
    <span class="n">jittery_motor1</span> <span class="o">=</span> <span class="n">SynAxis</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;jittery_motor1&#39;</span><span class="p">,</span>
                             <span class="n">readback_func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(),</span>
                             <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;motors&#39;</span><span class="p">})</span>
    <span class="n">jittery_motor2</span> <span class="o">=</span> <span class="n">SynAxis</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;jittery_motor2&#39;</span><span class="p">,</span>
                             <span class="n">readback_func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(),</span>
                             <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;motors&#39;</span><span class="p">})</span>
    <span class="n">noisy_det</span> <span class="o">=</span> <span class="n">SynGauss</span><span class="p">(</span><span class="s1">&#39;noisy_det&#39;</span><span class="p">,</span> <span class="n">motor</span><span class="p">,</span> <span class="s1">&#39;motor&#39;</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Imax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                         <span class="n">noise</span><span class="o">=</span><span class="s1">&#39;uniform&#39;</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">noise_multiplier</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                         <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;detectors&#39;</span><span class="p">})</span>
    <span class="n">det</span> <span class="o">=</span> <span class="n">SynGauss</span><span class="p">(</span><span class="s1">&#39;det&#39;</span><span class="p">,</span> <span class="n">motor</span><span class="p">,</span> <span class="s1">&#39;motor&#39;</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Imax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                   <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;detectors&#39;</span><span class="p">})</span>
    <span class="n">identical_det</span> <span class="o">=</span> <span class="n">SynGauss</span><span class="p">(</span><span class="s1">&#39;det&#39;</span><span class="p">,</span> <span class="n">motor</span><span class="p">,</span> <span class="s1">&#39;motor&#39;</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Imax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                             <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;detectors&#39;</span><span class="p">})</span>
    <span class="n">det1</span> <span class="o">=</span> <span class="n">SynGauss</span><span class="p">(</span><span class="s1">&#39;det1&#39;</span><span class="p">,</span> <span class="n">motor1</span><span class="p">,</span> <span class="s1">&#39;motor1&#39;</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Imax</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                    <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;detectors&#39;</span><span class="p">})</span>
    <span class="n">det2</span> <span class="o">=</span> <span class="n">SynGauss</span><span class="p">(</span><span class="s1">&#39;det2&#39;</span><span class="p">,</span> <span class="n">motor2</span><span class="p">,</span> <span class="s1">&#39;motor2&#39;</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">Imax</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;detectors&#39;</span><span class="p">})</span>
    <span class="n">det3</span> <span class="o">=</span> <span class="n">SynGauss</span><span class="p">(</span><span class="s1">&#39;det3&#39;</span><span class="p">,</span> <span class="n">motor3</span><span class="p">,</span> <span class="s1">&#39;motor3&#39;</span><span class="p">,</span> <span class="n">center</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">Imax</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;detectors&#39;</span><span class="p">})</span>
    <span class="n">det4</span> <span class="o">=</span> <span class="n">Syn2DGauss</span><span class="p">(</span><span class="s1">&#39;det4&#39;</span><span class="p">,</span> <span class="n">motor1</span><span class="p">,</span> <span class="s1">&#39;motor1&#39;</span><span class="p">,</span> <span class="n">motor2</span><span class="p">,</span> <span class="s1">&#39;motor2&#39;</span><span class="p">,</span>
                      <span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">Imax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;detectors&#39;</span><span class="p">})</span>
    <span class="n">det5</span> <span class="o">=</span> <span class="n">Syn2DGauss</span><span class="p">(</span><span class="s1">&#39;det5&#39;</span><span class="p">,</span> <span class="n">jittery_motor1</span><span class="p">,</span> <span class="s1">&#39;jittery_motor1&#39;</span><span class="p">,</span> <span class="n">jittery_motor2</span><span class="p">,</span>
                      <span class="s1">&#39;jittery_motor2&#39;</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">Imax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                      <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;detectors&#39;</span><span class="p">})</span>

    <span class="n">flyer1</span> <span class="o">=</span> <span class="n">MockFlyer</span><span class="p">(</span><span class="s1">&#39;flyer1&#39;</span><span class="p">,</span> <span class="n">det</span><span class="p">,</span> <span class="n">motor</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
    <span class="n">flyer2</span> <span class="o">=</span> <span class="n">MockFlyer</span><span class="p">(</span><span class="s1">&#39;flyer2&#39;</span><span class="p">,</span> <span class="n">det</span><span class="p">,</span> <span class="n">motor</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">trivial_flyer</span> <span class="o">=</span> <span class="n">TrivialFlyer</span><span class="p">()</span>
    <span class="n">new_trivial_flyer</span> <span class="o">=</span> <span class="n">NewTrivialFlyer</span><span class="p">()</span>

    <span class="n">ab_det</span> <span class="o">=</span> <span class="n">ABDetector</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;det&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;detectors&#39;</span><span class="p">})</span>
    <span class="c1"># area detector that directly stores image data in Event</span>
    <span class="n">direct_img</span> <span class="o">=</span> <span class="n">SynSignal</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))),</span>
                           <span class="n">name</span><span class="o">=</span><span class="s1">&#39;img&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;detectors&#39;</span><span class="p">})</span>
    <span class="c1"># area detector that stores data in a file</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">SynSignalWithRegistry</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))),</span>
                                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;img&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;detectors&#39;</span><span class="p">})</span>
    <span class="n">invariant1</span> <span class="o">=</span> <span class="n">InvariantSignal</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;invariant1&#39;</span><span class="p">,</span>
                                 <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;detectors&#39;</span><span class="p">})</span>
    <span class="n">invariant2</span> <span class="o">=</span> <span class="n">InvariantSignal</span><span class="p">(</span><span class="n">func</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;invariant2&#39;</span><span class="p">,</span>
                                 <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;detectors&#39;</span><span class="p">})</span>
    <span class="n">det_with_conf</span> <span class="o">=</span> <span class="n">DetWithConf</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;det&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;detectors&#39;</span><span class="p">})</span>
    <span class="n">det_with_count_time</span> <span class="o">=</span> <span class="n">DetWithCountTime</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;det&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;detectors&#39;</span><span class="p">})</span>
    <span class="n">rand</span> <span class="o">=</span> <span class="n">SynPeriodicSignal</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;rand&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;detectors&#39;</span><span class="p">})</span>
    <span class="n">rand2</span> <span class="o">=</span> <span class="n">SynPeriodicSignal</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;rand2&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;detectors&#39;</span><span class="p">})</span>
    <span class="n">motor_no_pos</span> <span class="o">=</span> <span class="n">SynAxisNoPosition</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;motor&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;motors&#39;</span><span class="p">})</span>
    <span class="n">bool_sig</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;bool_sig&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;detectors&#39;</span><span class="p">})</span>

    <span class="n">motor_no_hints1</span> <span class="o">=</span> <span class="n">SynAxisNoHints</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;motor1&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;motors&#39;</span><span class="p">})</span>
    <span class="n">motor_no_hints2</span> <span class="o">=</span> <span class="n">SynAxisNoHints</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;motor2&#39;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;motors&#39;</span><span class="p">})</span>
    <span class="c1"># Because some of these reference one another we must define them (above)</span>
    <span class="c1"># before we pack them into a namespace (below).</span>

    <span class="k">return</span> <span class="n">SimpleNamespace</span><span class="p">(</span>
        <span class="n">motor</span><span class="o">=</span><span class="n">motor</span><span class="p">,</span>
        <span class="n">motor1</span><span class="o">=</span><span class="n">motor1</span><span class="p">,</span>
        <span class="n">motor2</span><span class="o">=</span><span class="n">motor2</span><span class="p">,</span>
        <span class="n">motor3</span><span class="o">=</span><span class="n">motor3</span><span class="p">,</span>
        <span class="n">jittery_motor1</span><span class="o">=</span><span class="n">jittery_motor1</span><span class="p">,</span>
        <span class="n">jittery_motor2</span><span class="o">=</span><span class="n">jittery_motor2</span><span class="p">,</span>
        <span class="n">noisy_det</span><span class="o">=</span><span class="n">noisy_det</span><span class="p">,</span>
        <span class="n">det</span><span class="o">=</span><span class="n">det</span><span class="p">,</span>
        <span class="n">identical_det</span><span class="o">=</span><span class="n">identical_det</span><span class="p">,</span>
        <span class="n">det1</span><span class="o">=</span><span class="n">det1</span><span class="p">,</span>
        <span class="n">det2</span><span class="o">=</span><span class="n">det2</span><span class="p">,</span>
        <span class="n">det3</span><span class="o">=</span><span class="n">det3</span><span class="p">,</span>
        <span class="n">det4</span><span class="o">=</span><span class="n">det4</span><span class="p">,</span>
        <span class="n">det5</span><span class="o">=</span><span class="n">det5</span><span class="p">,</span>
        <span class="n">flyer1</span><span class="o">=</span><span class="n">flyer1</span><span class="p">,</span>
        <span class="n">flyer2</span><span class="o">=</span><span class="n">flyer2</span><span class="p">,</span>
        <span class="n">trivial_flyer</span><span class="o">=</span><span class="n">trivial_flyer</span><span class="p">,</span>
        <span class="n">new_trivial_flyer</span><span class="o">=</span><span class="n">new_trivial_flyer</span><span class="p">,</span>
        <span class="n">ab_det</span><span class="o">=</span><span class="n">ab_det</span><span class="p">,</span>
        <span class="n">direct_img</span><span class="o">=</span><span class="n">direct_img</span><span class="p">,</span>
        <span class="n">img</span><span class="o">=</span><span class="n">img</span><span class="p">,</span>
        <span class="n">invariant1</span><span class="o">=</span><span class="n">invariant1</span><span class="p">,</span>
        <span class="n">invariant2</span><span class="o">=</span><span class="n">invariant2</span><span class="p">,</span>
        <span class="n">pseudo3x3</span><span class="o">=</span><span class="n">SPseudo3x3</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;pseudo3x3&#39;</span><span class="p">),</span>
        <span class="n">pseudo1x3</span><span class="o">=</span><span class="n">SPseudo1x3</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;pseudo1x3&#39;</span><span class="p">),</span>
        <span class="n">sig</span><span class="o">=</span><span class="n">Signal</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;sig&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">det_with_conf</span><span class="o">=</span><span class="n">det_with_conf</span><span class="p">,</span>
        <span class="n">det_with_count_time</span><span class="o">=</span><span class="n">det_with_count_time</span><span class="p">,</span>
        <span class="n">rand</span><span class="o">=</span><span class="n">rand</span><span class="p">,</span>
        <span class="n">rand2</span><span class="o">=</span><span class="n">rand2</span><span class="p">,</span>
        <span class="n">motor_no_pos</span><span class="o">=</span><span class="n">motor_no_pos</span><span class="p">,</span>
        <span class="n">motor_no_hints1</span><span class="o">=</span><span class="n">motor_no_hints1</span><span class="p">,</span>
        <span class="n">motor_no_hints2</span><span class="o">=</span><span class="n">motor_no_hints2</span><span class="p">,</span>
        <span class="n">bool_sig</span><span class="o">=</span><span class="n">bool_sig</span><span class="p">,</span>
    <span class="p">)</span>


<span class="c1"># Dump instances of the example hardware generated by hw() into the global</span>
<span class="c1"># namespcae for convenience and back-compat.</span>
<span class="nb">globals</span><span class="p">()</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hw</span><span class="p">()</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Author.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>